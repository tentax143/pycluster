<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WinRay Cluster Metrics</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      margin: 0;
      padding: 20px;
    }
    nav {
      background: #1e293b;
      padding: 10px 20px;
      display: flex;
      gap: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    nav a {
      color: #94a3b8;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }
    nav a:hover {
      color: #60a5fa;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
    }
    .section {
      background: #1e293b;
      padding: 25px;
      margin: 25px auto;
      border-radius: 16px;
      max-width: 1000px;
      box-shadow: 0 10px 15px rgba(0,0,0,0.3);
    }
    canvas {
      margin-top: 20px;
      width: 100% !important;
      height: 250px !important;
    }
  </style>
</head>
<body>

<nav>
  <a href="/dashboard">Home</a>
  <a href="/metrics_page">Metrics Page</a>
</nav>

<h1>WinRay Cluster Metrics</h1>

<div class="section">
  <h2>Head Node Metrics</h2>
  <canvas id="headCpuChart"></canvas>
  <canvas id="headRamChart"></canvas>
  <canvas id="headGpuChart"></canvas>
  <canvas id="headDiskChart"></canvas>
</div>

<div class="section" id="worker-metrics-container">
  <h2>Worker Nodes Metrics</h2>
  <!-- Worker charts inserted here dynamically -->
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const headCpuCtx = document.getElementById('headCpuChart').getContext('2d');
  const headRamCtx = document.getElementById('headRamChart').getContext('2d');
  const headGpuCtx = document.getElementById('headGpuChart').getContext('2d');
  const headDiskCtx = document.getElementById('headDiskChart').getContext('2d');

  const maxDataPoints = 30;

  // Store data for charts
  const headData = {
    cpu: [],
    ram: [],
    gpu: [],
    disk: [],
    labels: []
  };

  const workerDataMap = {}; // keyed by worker id, each with cpu, ram, gpu, disk, labels arrays

  function createChart(ctx, label, color) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label,
          data: [],
          borderColor: color,
          backgroundColor: color + '40',
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 2
        }]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          y: {
            min: 0,
            max: 100,
            ticks: { stepSize: 10 },
            title: { display: true, text: '%' }
          },
          x: {
            title: { display: true, text: 'Time' }
          }
        },
        plugins: {
          legend: { display: true }
        }
      }
    });
  }

  const headCpuChart = createChart(headCpuCtx, 'CPU Usage', '#3b82f6');
  const headRamChart = createChart(headRamCtx, 'RAM Usage', '#ef4444');
  const headGpuChart = createChart(headGpuCtx, 'GPU Usage', '#10b981');
  const headDiskChart = createChart(headDiskCtx, 'Disk Usage', '#f59e0b');

  function addData(chart, label, data) {
    if (chart.data.labels.length >= maxDataPoints) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(data);
    chart.update('none');
  }

  async function fetchData() {
    try {
      const res = await fetch('/metrics');
      return await res.json();
    } catch (e) {
      console.error("Failed fetching metrics:", e);
      return null;
    }
  }

  function formatTime(date) {
    return date.toLocaleTimeString([], { hour12: false });
  }

  async function updateMetrics() {
    const data = await fetchData();
    if (!data) return;

    const now = new Date();
    const timeLabel = formatTime(now);

    // Head node metrics update
    addData(headCpuChart, timeLabel, data.head_info.cpu);
    addData(headRamChart, timeLabel, data.head_info.ram);
    addData(headGpuChart, timeLabel, data.head_info.gpu ?? 0);
    addData(headDiskChart, timeLabel, data.head_info.disk ?? 0);

    // Update worker charts
    const container = document.getElementById('worker-metrics-container');

    // For each worker, create charts if not exist
    for (const [id, worker] of Object.entries(data.workers)) {
      if (!workerDataMap[id]) {
        // Create a new section for this worker
        const section = document.createElement('div');
        section.classList.add('section');
        section.id = `worker-section-${id}`;
        section.innerHTML = `<h3>Worker ${id} Metrics</h3>
          <canvas id="workerCpuChart-${id}"></canvas>
          <canvas id="workerRamChart-${id}"></canvas>
          <canvas id="workerGpuChart-${id}"></canvas>
          <canvas id="workerDiskChart-${id}"></canvas>`;
        container.appendChild(section);

        workerDataMap[id] = {
          cpuChart: createChart(
            document.getElementById(`workerCpuChart-${id}`).getContext('2d'),
            `CPU Usage (Worker ${id})`, '#3b82f6'),
          ramChart: createChart(
            document.getElementById(`workerRamChart-${id}`).getContext('2d'),
            `RAM Usage (Worker ${id})`, '#ef4444'),
          gpuChart: createChart(
            document.getElementById(`workerGpuChart-${id}`).getContext('2d'),
            `GPU Usage (Worker ${id})`, '#10b981'),
          diskChart: createChart(
            document.getElementById(`workerDiskChart-${id}`).getContext('2d'),
            `Disk Usage (Worker ${id})`, '#f59e0b'),
        };
      }

      const charts = workerDataMap[id];
      addData(charts.cpuChart, timeLabel, worker.cpu ?? 0);
      addData(charts.ramChart, timeLabel, worker.ram ?? 0);
      addData(charts.gpuChart, timeLabel, worker.gpu ?? 0);
      addData(charts.diskChart, timeLabel, worker.disk ?? 0);
    }
  }

  setInterval(updateMetrics, 3000);
  updateMetrics();

</script>
</body>
</html>
