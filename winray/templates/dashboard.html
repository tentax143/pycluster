<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WinRay Cluster Dashboard</title>
  <style>
    /* Basic styling similar to your current style + dropdown tweaks */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      margin: 0;
      padding: 20px;
    }
    nav {
      background: #1e293b;
      padding: 10px 20px;
      display: flex;
      gap: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    nav a {
      color: #94a3b8;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }
    nav a:hover {
      color: #60a5fa;
    }
    h1, h2 {
      text-align: center;
      color: #94a3b8;
      margin: 10px 0 20px;
    }
    .section {
      background: #1e293b;
      padding: 25px;
      margin: 25px auto;
      border-radius: 16px;
      max-width: 1000px;
      box-shadow: 0 10px 15px rgba(0,0,0,0.3);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #1e293b;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid #334155;
    }
    th {
      background: #334155;
      color: #cbd5e1;
      font-weight: 600;
    }
    tr:hover {
      background: #2d3748;
    }
    .status-online {
      color: #4ade80;
      background: #14532d;
      padding: 6px 12px;
      border-radius: 20px;
      display: inline-block;
    }
    .status-offline {
      color: #f87171;
      background: #7f1d1d;
      padding: 6px 12px;
      border-radius: 20px;
      display: inline-block;
    }
    /* Dropdown styles */
    .worker-row {
      cursor: pointer;
      user-select: none;
    }
    .dropdown-content {
      display: none;
      background: #334155;
      color: #cbd5e1;
    }
    .dropdown-content td {
      text-align: left;
      padding: 10px 20px;
      border-bottom: none;
      font-size: 0.9rem;
    }
    .dropdown-content tr:hover {
      background: none;
    }
  </style>
</head>
<body>

  <nav>
    <a href="/dashboard">Home</a>
    <a href="/metrics_page">Metrics Page</a>
  </nav>

  <h1>WinRay Cluster Dashboard</h1>

  <div class="section">
    <h2>Head Node Info</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>IP</th><th>CPU Usage</th><th>RAM Usage</th><th>GPU Usage</th><th>Disk Usage</th>
        </tr>
      </thead>
      <tbody id="head-info-body"></tbody>
    </table>

    <h3>Top 5 Processes (by CPU%)</h3>
    <table>
      <thead>
        <tr><th>PID</th><th>Name</th><th>CPU %</th><th>Memory %</th></tr>
      </thead>
      <tbody id="head-processes-body"></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Worker Nodes</h2>
    <table>
      <thead>
        <tr><th>ID</th><th>IP</th><th>Port</th><th>CPU Usage</th><th>RAM Usage</th><th>Status</th></tr>
      </thead>
      <tbody id="worker-table-body"></tbody>
    </table>
  </div>

<script>
  async function fetchData() {
    try {
      const res = await fetch('/metrics');
      return await res.json();
    } catch (e) {
      console.error("Failed fetching metrics:", e);
      return null;
    }
  }

  function createWorkerDropdown(id, details) {
    const container = document.createElement('tbody');

    // Main row clickable
    const mainRow = document.createElement('tr');
    mainRow.classList.add('worker-row');
    mainRow.innerHTML = `
      <td>${id}</td>
      <td>${details.ip}</td>
      <td>${details.port}</td>
      <td>${details.cpu}%</td>
      <td>${details.ram}%</td>
      <td><span class="status-${details.status.toLowerCase()}">${details.status}</span></td>
    `;

    // Dropdown detail row (hidden by default)
    const dropdownRow = document.createElement('tr');
    dropdownRow.classList.add('dropdown-content');
    dropdownRow.innerHTML = `
      <td colspan="6">
        <strong>Details:</strong><br>
        Status: ${details.status}<br>
        IP: ${details.ip}<br>
        Port: ${details.port}<br>
        CPU: ${details.cpu}%<br>
        RAM: ${details.ram}%<br>
        GPU: ${details.gpu ?? 'N/A'}%<br>
        Disk: ${details.disk ?? 'N/A'}%<br>
        Last heartbeat: ${details.last_heartbeat ?? 'N/A'}
      </td>
    `;

    mainRow.addEventListener('click', () => {
      if (dropdownRow.style.display === 'table-row') {
        dropdownRow.style.display = 'none';
      } else {
        dropdownRow.style.display = 'table-row';
      }
    });

    container.appendChild(mainRow);
    container.appendChild(dropdownRow);

    return container;
  }

  async function updateDashboard() {
    const data = await fetchData();
    if (!data) return;

    // Update head info table
    const head = data.head_info;
    const headRowHtml = `<tr>
      <td>${head.name}</td>
      <td>${head.ip}</td>
      <td>${head.cpu}%</td>
      <td>${head.ram}%</td>
      <td>${head.gpu ?? 'N/A'}%</td>
      <td>${head.disk ?? 'N/A'}%</td>
    </tr>`;
    document.getElementById('head-info-body').innerHTML = headRowHtml;

    // Update top 5 processes table
    let procHtml = '';
    if (head.processes && head.processes.length > 0) {
      head.processes.forEach(proc => {
        procHtml += `<tr>
          <td>${proc.pid}</td>
          <td>${proc.name}</td>
          <td>${proc.cpu.toFixed(1)}</td>
          <td>${proc.memory.toFixed(1)}</td>
        </tr>`;
      });
    } else {
      procHtml = '<tr><td colspan="4">No process data</td></tr>';
    }
    document.getElementById('head-processes-body').innerHTML = procHtml;

    // Update worker table with dropdowns
    const workerBody = document.getElementById('worker-table-body');
    workerBody.innerHTML = '';
    for (const [id, w] of Object.entries(data.workers)) {
      const workerSection = createWorkerDropdown(id, w);
      workerBody.appendChild(workerSection);
    }
  }

  setInterval(updateDashboard, 3000);
  updateDashboard();
</script>
</body>
</html>
